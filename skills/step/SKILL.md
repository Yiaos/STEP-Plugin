# STEP Protocol â€” Core Rules

> Stateful Task Execution Protocol. å®Œæ•´è§„èŒƒè§ `WORKFLOW.md`ï¼ˆSTEP æ’ä»¶æ ¹ç›®å½•ï¼‰ã€‚

## Phase è§„åˆ™

### Phase 0: Discoveryï¼ˆå¼€æ”¾å¼è®¨è®ºï¼‰
- **ç”¨æˆ·ä¸»å¯¼**ï¼ŒLLM æ˜¯å¯¹è¯ä¼™ä¼´ï¼Œä¸é€ä¸ªæé—®
- ä¸åšæŠ€æœ¯å†³ç­–ï¼Œä¸å†™ä»£ç 
- ç›®æ ‡æ–¹å‘æ˜ç¡® + è¾¹ç•Œæ¸…æ™° + ç”¨æˆ·ç¡®è®¤ â†’ è¿›å…¥ Phase 1

### Phase 1: PRDï¼ˆé€‰æ‹©é¢˜ç¡®è®¤ï¼‰
- LLM èµ·è‰ `baseline.md` â†’ åˆ†æ®µå±•ç¤º â†’ é€‰æ‹©é¢˜é€é¡¹ç¡®è®¤
- ç¡®è®¤åå†™å…¥ `.step/baseline.md`ï¼Œæ ‡è®°å†»ç»“
- ä¿®æ”¹å†»ç»“å†…å®¹å¿…é¡»èµ° Change Request

### Phase 2: Tech Designï¼ˆå¼€æ”¾å¼è®¨è®ºï¼‰
- LLM æä¾›å…¨é¢æŠ€æœ¯æ–¹æ¡ˆå¯¹æ¯”ï¼ˆä¼˜åŠ£åŠ¿ã€é€‚ç”¨åœºæ™¯ã€æ¨èç†ç”±ï¼‰
- ç”¨æˆ·å¼€æ”¾è®¨è®ºï¼Œå¯è¿½é—®ç»†èŠ‚ã€æå‡ºæ–°æ–¹æ¡ˆ
- æ•´ä½“ç¡®å®šåï¼Œç»†èŠ‚ç”¨é€‰æ‹©é¢˜å¿«é€Ÿç¡®è®¤
- è¾“å‡º: `.step/tech-comparison.md` + `.step/decisions.md`

### Phase 3: Plan & Tasksï¼ˆç»“æ„åŒ–ç¡®è®¤ï¼‰
- ç”Ÿæˆä»»åŠ¡å›¾ + ä¾èµ–å…³ç³» + BDD åœºæ™¯çŸ©é˜µ
- æ¯ä¸ªä»»åŠ¡ YAML å«: happy_path / edge_cases / error_handling åœºæ™¯
- åœºæ™¯ ID æ ¼å¼: `S-{task}-{seq}` (å¦‚ `S-003-01`)
- æ¯ä¸ªåœºæ™¯é€šè¿‡ `test_type` æŒ‡å®šéªŒè¯æ–¹å¼ï¼ˆunit / integration / e2eï¼‰ï¼Œ**ä¸‰ç§ç±»å‹éƒ½æ˜¯å¿…é¡»çš„**
- ç”¨æˆ·å®¡æ ¸ç¡®è®¤åå†™å…¥ `.step/tasks/`

### Phase 4: Executionï¼ˆTDD + Gateï¼‰
```
Step 1: åŠ è½½ä¸Šä¸‹æ–‡ â†’ è¾“å‡ºçŠ¶æ€è¡Œ
Step 2: å†™æµ‹è¯•ï¼ˆæŒ‰ config.yaml test_writing æ¨¡å‹ï¼‰ â†’ ç¡®è®¤å…¨éƒ¨ FAIL (TDD RED)
Step 3: å†™å®ç°ï¼ˆæŒ‰æ¨¡å‹è·¯ç”±ï¼‰ â†’ æ¯åœºæ™¯è·‘ gate quick
Step 4: Gate éªŒè¯ â†’ gate.sh standard T-xxx
Step 5: Review + Commitï¼ˆæ¯å®Œæˆä¸€ä¸ªä»»åŠ¡éƒ½æ‰§è¡Œï¼‰
Step 6: æ›´æ–° state.yaml â†’ è¿›å…¥ä¸‹ä¸€ä»»åŠ¡
```

### Phase 5: Reviewï¼ˆç‹¬ç«‹éªŒè¯ï¼‰
æ¯å®Œæˆä¸€ä¸ªä»»åŠ¡è§¦å‘ï¼Œä¸ç­‰å…¨éƒ¨å®Œæˆã€‚

## Execution ç¡¬è§„åˆ™

1. **æµ‹è¯•å…ˆè¡Œ**: æŒ‰ `config.yaml` ä¸­ `test_writing.model` æŒ‡å®šçš„æ¨¡å‹å†™æµ‹è¯• â†’ ç¡®è®¤ FAIL â†’ å†å†™å®ç°ï¼ˆå»ºè®®æµ‹è¯•ä¸å®ç°ç”¨ä¸åŒæ¨¡å‹ä»¥å½¢æˆå¯¹æŠ—æ€§ï¼‰
2. **åœºæ™¯ ID ç»‘å®š**: æµ‹è¯•åå¿…é¡»åŒ…å« `[S-xxx-xx]`
3. **Gate å¿…è¿‡**: `./scripts/gate.sh standard T-xxx` é€šè¿‡æ‰èƒ½æ ‡ done
4. **åœºæ™¯ 100% è¦†ç›–**: `scenario-check.sh` éªŒè¯æ¯ä¸ªåœºæ™¯ ID éƒ½æœ‰å¯¹åº”æµ‹è¯•
5. **æ‰€æœ‰æµ‹è¯•ç±»å‹å¿…é¡»**: unit / integration / e2e éƒ½æ˜¯å¿…é¡»çš„ï¼Œä¸å¯è·³è¿‡

## Gate å¤±è´¥å¤„ç†

```
Gate å¤±è´¥ â†’ å¼ºæ¨¡å‹(Opus/Codex xhigh)åˆ†ææ ¹å› 
  â†’ root_cause + category + fix_strategy
  â†’ æŒ‰åˆ†ç±»ä¿®å¤ â†’ é‡è·‘ gate
  â†’ æœ€å¤šè‡ªåŠ¨ä¿®å¤ 3 è½®
  â†’ ä»å¤±è´¥ â†’ status: blocked + è¯·æ±‚äººå·¥ä»‹å…¥
```

**ç¦æ­¢ç›²ä¿®**ï¼šæ¯è½®ä¿®å¤å‰å¿…é¡»å…ˆåšå¤±è´¥åˆ†æã€‚

## Review ä¼˜å…ˆçº§

```
ç¬¬ä¸€ä¼˜å…ˆçº§: éœ€æ±‚åˆè§„ï¼ˆP0 é˜»æ–­ï¼‰
  â–¡ baseline.md çº¦æŸæœªè¿å
  â–¡ MVP Scope èŒƒå›´å†…
  â–¡ User Story / AC å…¨éƒ¨æ»¡è¶³
  â–¡ BDD åœºæ™¯ 100% è¦†ç›–
  â–¡ decisions.md ADR ä¸€è‡´

ç¬¬äºŒä¼˜å…ˆçº§: ä»£ç è´¨é‡ï¼ˆå‚è€ƒ code-review-expertï¼‰
  â–¡ SOLID
  â–¡ Securityï¼ˆXSS/æ³¨å…¥/SSRF/AuthZï¼‰
  â–¡ é”™è¯¯å¤„ç† / æ€§èƒ½ / è¾¹ç•Œæ¡ä»¶
```

ä¸¥é‡ç¨‹åº¦: P0(éœ€æ±‚ä¸åˆè§„/å®‰å…¨/æ•°æ®ä¸¢å¤±) > P1(åœºæ™¯ç¼ºå¤±/é€»è¾‘é”™è¯¯) > P2(ä»£ç å¼‚å‘³) > P3(é£æ ¼)

## é˜²æ¼‚ç§»æœºåˆ¶

- baseline.md å†»ç»“åä¸å¯ç›´æ¥ä¿®æ”¹ â†’ èµ° Change Request
- ä¸å¯å¼•å…¥æœªç» ADR è®°å½•çš„æ¶æ„å†³ç­–
- Post-MVP: éœ€æ±‚å˜æ›´ â†’ CRï¼ŒBug â†’ Hotfixï¼Œçº¦æŸå˜æ›´ â†’ é«˜å½±å“ CR

## ä¿è¯ä¸é™åˆ¶

### ç¡¬ä¿è¯ï¼ˆæŠ€æœ¯å±‚é¢å¼ºåˆ¶ï¼‰
1. **gate.sh / scenario-check.sh** â€” è„šæœ¬æ‰§è¡Œç»“æœæ˜¯ç¡®å®šæ€§çš„ï¼Œè·‘äº†å°±å‡†
2. **Subagent æ¨¡å‹ç»‘å®š** â€” é€šè¿‡ `agents/*.md` å®šä¹‰ + `oh-my-opencode` é…ç½®ï¼Œsubagent å¯åŠ¨æ—¶æ¨¡å‹ç¡®å®š
3. **SessionStart Hook æ³¨å…¥** â€” æœ‰ `.step/` ç›®å½•å°±ä¸€å®šæ³¨å…¥çŠ¶æ€åˆ°ä¸Šä¸‹æ–‡
4. **æ–‡ä»¶æ¨¡æ¿ç»“æ„** â€” step-init.sh åˆ›å»ºçš„æ–‡ä»¶ç»“æ„æ˜¯ç¡®å®šæ€§çš„

### è½¯ä¿è¯ï¼ˆprompt å±‚é¢ï¼Œä¾èµ– LLM éµå®ˆï¼‰
1. Phase æµè½¬é¡ºåº â€” LLM å¯èƒ½è·³è¿‡é˜¶æ®µ
2. TDD å…ˆæµ‹è¯•åå®ç° â€” LLM å¯èƒ½å…ˆå†™å®ç°
3. æ¯æ¬¡éƒ½è·‘ gate â€” LLM å¯èƒ½è·³è¿‡ gate ç›´æ¥æ ‡ done
4. baseline å†»ç»“ä¸ç›´æ¥æ”¹ â€” æ–‡ä»¶ç³»ç»Ÿæ— å†™ä¿æŠ¤
5. ä» next_action æ¢å¤ â€” LLM å¯èƒ½ä¸éµå®ˆ

### ä¸èƒ½ä¿è¯ï¼ˆéœ€è¦å¤–éƒ¨æœºåˆ¶ï¼‰
1. ä¸»ä¼šè¯ä¸­é€”åˆ‡æ¨¡å‹ â€” opencode å¯åŠ¨æ—¶é€‰å®šæ¨¡å‹ï¼Œsession å†…ä¸å¯å˜
2. æ–‡ä»¶å†™ä¿æŠ¤ â€” baseline å†»ç»“æ˜¯å¥‘çº¦ä¸æ˜¯æ–‡ä»¶é”

### æé«˜éµå®ˆç‡çš„è®¾è®¡
- Hook è‡ªåŠ¨æ³¨å…¥è§„åˆ™ï¼ˆä¸ä¾èµ–ç”¨æˆ·è®°å¾—æé†’ï¼‰
- è§’è‰²åˆ‡æ¢ï¼ˆä¸åŒ Phase ç”¨ä¸åŒ agentï¼Œæ¯ä¸ª agent æœ‰é’ˆå¯¹æ€§çº¦æŸï¼‰
- gate.sh æ˜¯çœŸå®å¯æ‰§è¡Œè„šæœ¬ï¼ˆä¸æ˜¯ checklistï¼‰
- scenario-check.sh ç”¨ grep ç¡¬åŒ¹é…ï¼ˆä¸æ˜¯ LLM åˆ¤æ–­ï¼‰

## Session ç®¡ç†

### å¯¹è¯ç»“æŸæ—¶å¿…é¡»åš
1. æ›´æ–° `state.yaml`: last_updated, progress, next_action
2. `next_action` ç²¾ç¡®åˆ°æ–‡ä»¶åå’Œå…·ä½“åŠ¨ä½œ
3. **ç¦æ­¢å†™** "ç»§ç»­å¼€å‘" / "åç»­å¤„ç†"

### æ¢å¤ Session æ—¶
1. è¯» state.yaml â†’ è¯»å½“å‰ task â†’ è¯» baseline
2. è¾“å‡º: `ğŸ“ Phase X | Task: T-xxx | Status: xxx | Next: xxx`
3. ä» next_action ç»§ç»­

## æ¨¡å‹è·¯ç”±ï¼ˆå‚è€ƒ .step/config.yamlï¼‰

| é˜¶æ®µ | æ¨¡å‹ |
|------|------|
| Phase 0-3 è§„åˆ’ | claude-opus |
| æµ‹è¯•ç¼–å†™ | æŒ‰ config.yaml é…ç½®ï¼ˆé»˜è®¤ codexï¼‰ |
| å‰ç«¯å®ç° | gemini |
| åç«¯å®ç° | codex |
| å¤æ‚é€»è¾‘ | claude-opus |
| Review | claude-opus æˆ– codex |

## è§’è‰²ä¸ Agent æ˜ å°„

STEP å®šä¹‰ 4 ä¸ªè§’è‰²ï¼Œé€šè¿‡ `agents/*.md` å®ç° subagent æ¨¡å‹ç»‘å®šï¼š

| è§’è‰² | Agent æ–‡ä»¶ | æ¨¡å‹ | é€‚ç”¨é˜¶æ®µ |
|------|-----------|------|---------|
| PMï¼ˆäº§å“ç»ç†ï¼‰ | `agents/pm.md` | claude-opus | Phase 0, 1 |
| Architectï¼ˆæ¶æ„å¸ˆï¼‰ | `agents/architect.md` | claude-opus | Phase 2, 3 |
| QAï¼ˆè´¨é‡å·¥ç¨‹å¸ˆï¼‰ | `agents/qa.md` | claude-sonnet-thinking | Phase 3 åœºæ™¯è¡¥å……, Phase 4 Gate åˆ†æ, Phase 5 Review |
| Developerï¼ˆå¼€å‘è€…ï¼‰ | `agents/developer.md` | codex | Phase 4 |

**åˆ¶è¡¡åŸåˆ™**: PM å®šä¹‰"åšä»€ä¹ˆ"ã€Architect å®šä¹‰"æ€ä¹ˆåš"ã€QA å®šä¹‰"æ€ä¹ˆç ´åå®ƒ"ã€Developer åªåšè¢«å®šä¹‰çš„äº‹ã€‚

## å¯¹è¯æ¨¡å¼

| æ¨¡å¼ | é˜¶æ®µ | ç‰¹å¾ |
|------|------|------|
| å¼€æ”¾å¼è®¨è®º | Phase 0, 2 | ç”¨æˆ·ä¸»å¯¼ï¼ŒLLM å›åº”åˆ†æ |
| é€‰æ‹©é¢˜ç¡®è®¤ | Phase 1, 3 | LLM æä¾›ç»“æ„åŒ–é€‰é¡¹ï¼Œé€é¡¹ç¡®è®¤ |

## Post-MVP æµç¨‹

Post-MVP å˜æ›´**åŒæ ·éµå¾ª STEP åè®®**ï¼Œæ‰€æœ‰è¿‡ç¨‹è®°å½•åœ¨ `.step/` ä¸‹ï¼š

- **Change Request**: éœ€æ±‚å˜æ›´ â†’ `.step/change-requests/YYYY-MM-DD-CR-xxx.yaml` â†’ ç”¨æˆ·å®¡æ‰¹ â†’ æ›´æ–° baseline â†’ åˆ›å»ºæ–° task YAMLï¼ˆå«åœºæ™¯çŸ©é˜µï¼‰ â†’ Phase 4 æ‰§è¡Œ â†’ gate + review + commit
- **Hotfix**: Bug â†’ å®šä½åœºæ™¯ â†’ `.step/tasks/YYYY-MM-DD-T-xxx-hotfix-xxx.yaml` â†’ TDD ä¿®å¤ â†’ gate full å›å½’ â†’ review + commit â†’ æ›´æ–° state.yaml
- **çº¦æŸå˜æ›´**: é«˜å½±å“ CR â†’ å½±å“åˆ†æ â†’ `.step/tasks/YYYY-MM-DD-T-MIGRATE-xxx.yaml` â†’ Phase 4 æ‰§è¡Œ â†’ gate full

**å‘½åè§„åˆ™**: CR å’Œ Hotfix æ–‡ä»¶åä»¥æ—¥æœŸå¼€å¤´ï¼ˆ`YYYY-MM-DD-`ï¼‰ï¼Œä¾¿äºæŒ‰æ—¶é—´æŸ¥æ‰¾ã€‚
